{% extends "base.html" %}

{% block body %}
<div class="container mt-3" id="main">
    <h1>Eintrag bearbeiten</h1>
    {{ helper_templates::EditEntryNavbar::new(base.request,
                                              *base.event.expect("Event should always be known").id,
                                              entry.entry.id,
                                              base.current_date.expect("For non-new entries, `entry_id` should always be known."),
                                              helper_templates::EditEntryNavbarActiveLink::DeleteEntry,
       )|safe }}

    <h2>Aktueller Eintrag</h2>
    {# TODO deduplicate code #}
    <table class="table table-striped kuealist">
        <thead>
        <tr>
            <th>Was?</th>
            <th>Wann?</th>
            <th>Wo?</th>
            <th>Von wem?</th>
        </tr>
        </thead>
        <tbody>
        <tr style="{{ Self::css_for_category_color(entry_category) }}" class="kuea-with-category">
            <td class="kuea-title" id="entry-{{ entry.entry.id.to_string() }}">
                {% if entry.entry.is_cancelled %}
                <span class="visually-hidden">Abgesagt: </span>
                {% endif %}
                <span class="content">{{ entry.entry.title }}</span>
                {% if !entry.entry.comment.is_empty() %}
                <div class="comment">{{ entry.entry.comment }}</div>
                {% endif %}
            </td>
            <td class="kuea-time">
                <small>{{ to_our_timezone(entry.entry.begin).format("%d.%m.") }}</small>
                {{ to_our_timezone(entry.entry.begin).format("%H:%M") }}&nbsp;– {{ to_our_timezone(entry.entry.end).format("%H:%M") }}
                {% let duration = entry.entry.end.signed_duration_since(entry.entry.begin) %}
                {% if duration >= chrono::TimeDelta::days(1) %}
                    (+{{ duration.num_days() }}&nbsp;Tag{{ duration.num_days()|pluralize("", "e") }})
                {% endif %}
                {% if !entry.entry.time_comment.is_empty() %}
                    <div class="comment">{{ entry.entry.time_comment }}</div>
                {% endif %}
            </td>
            <td class="kuea-place">
                {% for room_id in entry.room_ids %}
                {{ rooms[room_id].title }}{% if !loop.last %}, {% endif -%}
                {% endfor %}
                {% if !entry.entry.room_comment.is_empty() %}
                <div class="comment">{{ entry.entry.room_comment }}</div>
                {% endif %}
            </td>
            <td class="kuea-people">{{ entry.entry.responsible_person }}</td>
        </tr>
        </tbody>
    </table>
    <div class="card border-danger mt-5">
        <h2 class="card-header border-danger">
            Löschen
        </h2>
        <div class="card-body">
            <form class="row align-items-center mb-3" method="post" action="{{ base.request.url_for("delete_entry", [event.id.to_string(), entry.entry.id.to_string()])? }}">
                <div class="col-md-auto mb-2 mb-md-0">
                    <button type="submit" class="btn btn-danger"><i class="bi bi-trash" aria-hidden="true"></i> Löschen</button>
                </div>
                <div class="col-md text-secondary">
                    Diesen Eintrag vollständig aus dem KüA-Plan löschen.
                    Der Eintrag bleibt zwar aus technischen Gründen weiterhin in der Datenbank gespeichert, kann aber nicht ohne Eingriff eines Admins wiederhergestellt werden.
                </div>
            </form>
            <form class="row align-items-center" method="post" action="{{ base.request.url_for("mark_entry_cancelled", [event.id.to_string(), entry.entry.id.to_string()])? }}">
                <div class="col-md-auto mb-2 mb-md-0">
                    <button type="submit" class="btn btn-primary" {% if entry.entry.is_cancelled %}disabled{% endif %}>
                        <i class="bi bi-x-circle" aria-hidden="true"></i> Als „fällt aus“ markieren
                    </button>
                </div>
                <div class="col-md text-secondary">
                    Diesen Eintrag ändern, sodass er als ausfallend dargestellt wird.
                    Dies entspricht der Option „fällt aus“ im Bearbeitungs-Formular.
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
